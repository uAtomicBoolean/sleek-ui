import { UAppTheme } from "../../sleek-ui/app-theme.slint";


component Scrollbar inherits Rectangle {
    in-out property <Orientation> orientation: vertical;
    in-out property <length> value;
    in-out property <length> max-scroll-pos;
    in property <length> handle-size;
    out property <bool> pressed <=> touch.pressed;
    private property <length> available-space: (orientation == Orientation.vertical ? self.height : self.width) - handle-size;
	// TODO apply min-handle-pct
	// TODO Handle shrinking when reducing window height to its maximum.
	//		Handle should keep the same height after passing the min-handle-pct threshold.
    private property <float> min-handle-pct: 0.05;
    width: orientation == Orientation.vertical ? 8px * UAppTheme.scale-factor : 0;
    height: orientation == Orientation.horizontal ? 8px * UAppTheme.scale-factor : 0;
    handle := Rectangle {
        x: orientation == Orientation.horizontal ? -value / max-scroll-pos * (root.width - handle-size) : 1px;
        y: orientation == Orientation.vertical ? -value / max-scroll-pos * (root.height - handle-size) : 1px;
        width: orientation == Orientation.vertical ? 6px * UAppTheme.scale-factor : handle-size;
        height: orientation == Orientation.horizontal ? 6px * UAppTheme.scale-factor : handle-size;
        background: UAppTheme.color-fill;
        border-radius: UAppTheme.radius-circle;
        animate background { duration: UAppTheme.animation-duration; }
        states [
            hover when touch.has-hover: {
                background: UAppTheme.color-fill-plus;
            }
        ]
    }

    touch := TouchArea {
        private property <length> initial-pressed;
        pointer-event(event) => {
            if event.button == PointerEventButton.left && event.kind == PointerEventKind.down {
                initial-pressed = self.mouse-y;
            }
        }
        moved => {
            if orientation == Orientation.vertical && self.mouse-y >= 0 && self.mouse-y <= root.height {
                let move-diff = initial-pressed - self.mouse-y;
                let new-y = max(0px, min(available-space, handle.y - move-diff));
                initial-pressed = self.mouse-y;
                value = -(max-scroll-pos * (new-y / available-space));
            } else if orientation == Orientation.horizontal && self.mouse-x >= 0 && self.mouse-x <= root.width {
                let move-diff = initial-pressed - self.mouse-x;
                let new-x = max(0px, min(available-space, handle.x - move-diff));
                initial-pressed = self.mouse-x;
                value = -(max-scroll-pos * (new-x / available-space));
            }
        }
    }
}

export component UScrollview inherits Rectangle {
    in-out property <bool> interactive: false;
    out property <length> scrollbar-area: 8px * UAppTheme.scale-factor;
    out property <length> viewport-x <=> flickable.viewport-x;
    out property <length> viewport-y <=> flickable.viewport-y;
    out property <length> viewport-width <=> flickable.viewport-width;
    out property <length> viewport-height <=> flickable.viewport-height;
    private property <duration> scroll-anim-duration: !h-scrollbar.pressed && !v-scrollbar.pressed ? UAppTheme.animation-duration : 0;
    VerticalLayout {
        flickable := Flickable {
            horizontal-stretch: 2;
            vertical-stretch: 2;
            interactive: root.interactive;
            viewport-y <=> h-scrollbar.value;
            viewport-x <=> v-scrollbar.value;
            animate viewport-x, viewport-y { duration: scroll-anim-duration; }
            @children
        }
    }

    h-scrollbar := Scrollbar {
        y: 0;
        x: root.width - self.width;
        height: root.height - (v-scrollbar.visible ? v-scrollbar.height : 0);
        visible: flickable.viewport-height > flickable.height;
        max-scroll-pos: flickable.viewport-height - flickable.height;
        handle-size: flickable.height / flickable.viewport-height * flickable.height;
    }

    v-scrollbar := Scrollbar {
        orientation: horizontal;
        x: 0;
        y: root.height - self.height;
        width: root.width - (h-scrollbar.visible ? h-scrollbar.width : 0);
        visible: flickable.viewport-width > flickable.width;
        max-scroll-pos: flickable.viewport-width - flickable.width;
        handle-size: flickable.width / flickable.viewport-width * flickable.width;
    }
}
